{% extends "base.html" %}
{% block title %}CareerCraft{% endblock %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/quiz.css') }}" />
{% endblock %}
{% block content %}
<div class="quiz-container">
    <div id="quiz-container"></div>
    <button id="next-button" onclick="nextSection()">Next</button>
    <button id="submit-button" onclick="submitQuiz()" style="display: none;">Submit</button>
</div>
{% endblock %}

{% block scripts %}
<script>
    const quizData = JSON.parse('{{data|tojson}}');
    console.log(quizData);

    
let currentSectionIndex = 0;
let userAnswers = {};

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function loadSection() {
    const skills = quizData;
    if (currentSectionIndex < skills.length) {
        const skill = skills[currentSectionIndex];
        const questions = shuffle(skill.questions);
        const quizContainer = document.getElementById('quiz-container');
        quizContainer.innerHTML = `<h2>${skill.skill}</h2>`;
        questions.forEach((q, index) => {
            const allAnswers = shuffle([...q.correct, ...q.wrong]);
            quizContainer.innerHTML += `
                <div class="question">
                    <p>${q.question}</p>
                    ${allAnswers.map((answer, i) => `
                        <label>
                            <input type="radio" name="q${index}" value="${answer}">
                            ${answer}
                        </label>
                    `).join('')}
                </div>
            `;
        });
    } else {
        document.getElementById('next-button').style.display = 'none';
        document.getElementById('submit-button').style.display = 'block';
    }
}

function nextSection() {
    const skills = quizData;
    const skill = skills[currentSectionIndex];
    const questions = skill.questions;
    userAnswers[skill.skill] = [];
    questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        userAnswers[skill.skill].push(selected ? selected.value : null);
    });
    currentSectionIndex++;
    loadSection();
}

function computeMarks() {
    const marks = [];
    quizData.forEach(skill => {
        const questions = skill.questions;
        const answers = userAnswers[skill.skill];
        let score = 0;
        questions.forEach((q, index) => {
            if (answers[index] && q.correct.includes(answers[index])) score++;
        });
        marks.push({ skill: skill.skill, mark: score });
    });
    return marks;
}

function submitQuiz() {
    const marks = computeMarks();
    console.log(marks); // For testing purposes

    const endpoint = `{{ url_for("activity.process_quiz", project_id = project_id)}}`

    // Send AJAX request
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(marks)
    })
    .then(response => response.json())
    .then(data => {
        window.location.href = data.redirect;
        console.log('Success:', data);
    })
    .catch((error) => {
        window.location.href = `{{ url_for("activity.learning", project_id = project_id) }}`;
        console.error('Error:', error);
    });
}

loadSection();

</script>
{% endblock %}